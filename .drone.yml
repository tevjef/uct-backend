workspace:
  base: /go
  path: src/github.com/tevjef/uct-core

pipeline:
  core:
    image: golang:1.9-alpine
    environment:
      - GOPATH=/go
    commands:
      - go version
      - export GOOS=linux
      - export GOARCH=amd64
      - apk update
      - apk --no-cache add ca-certificates openssl git
      - update-ca-certificates
      - go get -u github.com/golang/dep/cmd/dep
      - dep ensure -v
      - export PATH=$PATH:$GOPATH/bin
      - go install -v -ldflags "-s -w" github.com/tevjef/uct-core/ein
      - go install -v -ldflags "-s -w" github.com/tevjef/uct-core/hermes
      - go install -v -ldflags "-s -w" github.com/tevjef/uct-core/julia
      - go install -v -ldflags "-s -w" github.com/tevjef/uct-core/scrapers/rutgers
      - go install -v -ldflags "-s -w" github.com/tevjef/uct-core/scrapers/njit
      - go install -v -ldflags "-s -w" github.com/tevjef/uct-core/scrapers/cuny
      - go install -v -ldflags "-s -w" github.com/tevjef/uct-core/jet
      - go install -v -ldflags "-s -w" github.com/tevjef/uct-core/spike
    when:
      event: [push, pull_request, tag, deployment]

  common:
    image: library/docker:dind
    commands:
      - cp /go/bin/ein docker/ein/
      - cp /go/bin/spike docker/spike/
      - cp /go/bin/hermes docker/hermes/
      - cp /go/bin/julia docker/julia/

      - cp /go/bin/rutgers docker/rutgers/
      - cp /go/bin/njit docker/njit/
      - cp /go/bin/cuny docker/cuny/

      - cp /go/bin/jet docker/rutgers/
      - cp /go/bin/jet docker/njit/
      - cp /go/bin/jet docker/cuny/

      - cp common/conf/config.toml docker/ein/
      - cp common/conf/config.toml docker/spike/
      - cp common/conf/config.toml docker/hermes/
      - cp common/conf/config.toml docker/julia/
      - cp common/conf/config.toml docker/rutgers/
      - cp common/conf/config.toml docker/njit/
      - cp common/conf/config.toml docker/cuny/
    when:
      branch: [production, staging, develop]
      event: [push, tag, deployment]

  production:
    image: library/docker:dind
    commands:
      - docker login --username=$DOCKER_USERNAME --password=$DOCKER_PASSWORD

      - docker build -t tevjef/ein:$DRONE_COMMIT_BRANCH -f docker/ein/Dockerfile docker/ein
      - docker build -t tevjef/spike:$DRONE_COMMIT_BRANCH -f docker/spike/Dockerfile docker/spike
      - docker build -t tevjef/hermes:$DRONE_COMMIT_BRANCH -f docker/hermes/Dockerfile docker/hermes
      - docker build -t tevjef/julia:$DRONE_COMMIT_BRANCH -f docker/julia/Dockerfile docker/julia
      - docker build -t tevjef/rutgers:$DRONE_COMMIT_BRANCH -f docker/rutgers/Dockerfile docker/rutgers
      - docker build -t tevjef/njit:$DRONE_COMMIT_BRANCH -f docker/njit/Dockerfile docker/njit
      - docker build -t tevjef/cuny:$DRONE_COMMIT_BRANCH -f docker/cuny/Dockerfile docker/cuny
      - docker build -t tevjef/postgresql:$DRONE_COMMIT_BRANCH -f support/postgresql/Dockerfile support/postgresql

      - docker push tevjef/ein:$DRONE_COMMIT_BRANCH
      - docker push tevjef/spike:$DRONE_COMMIT_BRANCH
      - docker push tevjef/hermes:$DRONE_COMMIT_BRANCH
      - docker push tevjef/julia:$DRONE_COMMIT_BRANCH
      - docker push tevjef/rutgers:$DRONE_COMMIT_BRANCH
      - docker push tevjef/njit:$DRONE_COMMIT_BRANCH
      - docker push tevjef/cuny:$DRONE_COMMIT_BRANCH
      - docker push tevjef/postgresql:$DRONE_COMMIT_BRANCH
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    when:
      branch: production
      event: [push, tag, deployment]

  staging:
    image: library/docker:dind
    commands:
      - docker login --username=$DOCKER_USERNAME --password=$DOCKER_PASSWORD

      - docker build -t tevjef/ein:$DRONE_COMMIT_BRANCH -f docker/ein/Dockerfile docker/ein
      - docker build -t tevjef/spike:$DRONE_COMMIT_BRANCH -f docker/spike/Dockerfile docker/spike
      - docker build -t tevjef/hermes:$DRONE_COMMIT_BRANCH -f docker/hermes/Dockerfile docker/hermes
      - docker build -t tevjef/julia:$DRONE_COMMIT_BRANCH -f docker/julia/Dockerfile docker/julia
      - docker build -t tevjef/rutgers:$DRONE_COMMIT_BRANCH -f docker/rutgers/Dockerfile docker/rutgers
      - docker build -t tevjef/njit:$DRONE_COMMIT_BRANCH -f docker/njit/Dockerfile docker/njit
      - docker build -t tevjef/cuny:$DRONE_COMMIT_BRANCH -f docker/cuny/Dockerfile docker/cuny
      - docker build -t tevjef/postgresql:$DRONE_COMMIT_BRANCH -f support/postgresql/Dockerfile support/postgresql

      - docker push tevjef/ein:$DRONE_COMMIT_BRANCH
      - docker push tevjef/spike:$DRONE_COMMIT_BRANCH
      - docker push tevjef/hermes:$DRONE_COMMIT_BRANCH
      - docker push tevjef/julia:$DRONE_COMMIT_BRANCH
      - docker push tevjef/rutgers:$DRONE_COMMIT_BRANCH
      - docker push tevjef/njit:$DRONE_COMMIT_BRANCH
      - docker push tevjef/cuny:$DRONE_COMMIT_BRANCH
      - docker push tevjef/postgresql:$DRONE_COMMIT_BRANCH
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    when:
      branch: staging
      event: [push, tag, deployment]

  develop:
    image: library/docker:dind
    commands:
      - docker login --username=$DOCKER_USERNAME --password=$DOCKER_PASSWORD

      - docker build -t tevjef/ein:$DRONE_COMMIT_BRANCH -f docker/ein/Dockerfile docker/ein
      - docker build -t tevjef/spike:$DRONE_COMMIT_BRANCH -f docker/spike/Dockerfile docker/spike
      - docker build -t tevjef/hermes:$DRONE_COMMIT_BRANCH -f docker/hermes/Dockerfile docker/hermes
      - docker build -t tevjef/julia:$DRONE_COMMIT_BRANCH -f docker/julia/Dockerfile docker/julia
      - docker build -t tevjef/rutgers:$DRONE_COMMIT_BRANCH -f docker/rutgers/Dockerfile docker/rutgers
      - docker build -t tevjef/njit:$DRONE_COMMIT_BRANCH -f docker/njit/Dockerfile docker/njit
      - docker build -t tevjef/cuny:$DRONE_COMMIT_BRANCH -f docker/cuny/Dockerfile docker/cuny
      - docker build -t tevjef/postgresql:$DRONE_COMMIT_BRANCH -f support/postgresql/Dockerfile support/postgresql

      - docker push tevjef/ein:$DRONE_COMMIT_BRANCH
      - docker push tevjef/spike:$DRONE_COMMIT_BRANCH
      - docker push tevjef/hermes:$DRONE_COMMIT_BRANCH
      - docker push tevjef/julia:$DRONE_COMMIT_BRANCH
      - docker push tevjef/rutgers:$DRONE_COMMIT_BRANCH
      - docker push tevjef/njit:$DRONE_COMMIT_BRANCH
      - docker push tevjef/cuny:$DRONE_COMMIT_BRANCH
      - docker push tevjef/postgresql:$DRONE_COMMIT_BRANCH

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    when:
      branch: develop
      event: [push]

  kubernetes-deploy-staging:
    image: library/docker:dind
    commands:
      - docker login --username=$DOCKER_USERNAME --password=$DOCKER_PASSWORD

      # Install Kubectl
      - apk update
      - apk add curl
      - curl -LO https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl
      - chmod +x ./kubectl && mv ./kubectl /usr/local/bin/kubectl

      # Setup Kubectl
      - kubectl config set-credentials default --token=$(echo -n $KUBERNETES_TOKEN | base64 -d)
      - kubectl config set-cluster default --server=$KUBERNETES_MASTER --insecure-skip-tls-verify=true
      - kubectl config set-context default --cluster=default --user=default
      - kubectl config use-context default

      - cd /go/src/github.com/tevjef/uct-core
      - kubectl -n $DRONE_COMMIT_BRANCH apply -R -f kubernetes/staging

      - DIGEST=$(docker inspect --format='{{ index .RepoDigests 0 }}' tevjef/ein:$DRONE_COMMIT_BRANCH)
      - kubectl -n $DRONE_COMMIT_BRANCH set image deployment/ein ein=$DIGEST
  
      - DIGEST=$(docker inspect --format='{{ index .RepoDigests 0 }}' tevjef/spike:$DRONE_COMMIT_BRANCH)
      - kubectl -n $DRONE_COMMIT_BRANCH set image deployment/spike spike=$DIGEST
  
      - DIGEST=$(docker inspect --format='{{ index .RepoDigests 0 }}' tevjef/hermes:$DRONE_COMMIT_BRANCH)
      - kubectl -n $DRONE_COMMIT_BRANCH set image deployment/hermes hermes=$DIGEST
  
      - DIGEST=$(docker inspect --format='{{ index .RepoDigests 0 }}' tevjef/julia:$DRONE_COMMIT_BRANCH)
      - kubectl -n $DRONE_COMMIT_BRANCH set image deployment/julia julia=$DIGEST
  
      - DIGEST=$(docker inspect --format='{{ index .RepoDigests 0 }}' tevjef/rutgers:$DRONE_COMMIT_BRANCH)
      - kubectl -n $DRONE_COMMIT_BRANCH set image deployment/rutgers-cm rutgers-cm=$DIGEST
      - kubectl -n $DRONE_COMMIT_BRANCH set image deployment/rutgers-nb rutgers-nb=$DIGEST
      - kubectl -n $DRONE_COMMIT_BRANCH set image deployment/rutgers-nk rutgers-nk=$DIGEST

      - DIGEST=$(docker inspect --format='{{ index .RepoDigests 0 }}' tevjef/njit:staging)
      - kubectl -n $DRONE_COMMIT_BRANCH set image deployment/njit njit=$DIGEST

      - DIGEST=$(docker inspect --format='{{ index .RepoDigests 0 }}' tevjef/cuny:staging)
      - kubectl -n $DRONE_COMMIT_BRANCH set image deployment/cuny-bar cuny-bar=$DIGEST
      - kubectl -n $DRONE_COMMIT_BRANCH set image deployment/cuny-bcc cuny-bcc=$DIGEST
      - kubectl -n $DRONE_COMMIT_BRANCH set image deployment/cuny-bkl cuny-bkl=$DIGEST
      - kubectl -n $DRONE_COMMIT_BRANCH set image deployment/cuny-bmc cuny-bmc=$DIGEST
      - kubectl -n $DRONE_COMMIT_BRANCH set image deployment/cuny-csi cuny-csi=$DIGEST
      - kubectl -n $DRONE_COMMIT_BRANCH set image deployment/cuny-cty cuny-cty=$DIGEST
      - kubectl -n $DRONE_COMMIT_BRANCH set image deployment/cuny-hos cuny-hos=$DIGEST
      - kubectl -n $DRONE_COMMIT_BRANCH set image deployment/cuny-htr cuny-htr=$DIGEST
      - kubectl -n $DRONE_COMMIT_BRANCH set image deployment/cuny-jjc cuny-jjc=$DIGEST
      - kubectl -n $DRONE_COMMIT_BRANCH set image deployment/cuny-kcc cuny-kcc=$DIGEST
      - kubectl -n $DRONE_COMMIT_BRANCH set image deployment/cuny-lag cuny-lag=$DIGEST
      - kubectl -n $DRONE_COMMIT_BRANCH set image deployment/cuny-leh cuny-leh=$DIGEST
      - kubectl -n $DRONE_COMMIT_BRANCH set image deployment/cuny-mec cuny-mec=$DIGEST
      - kubectl -n $DRONE_COMMIT_BRANCH set image deployment/cuny-nyt cuny-nyt=$DIGEST
      - kubectl -n $DRONE_COMMIT_BRANCH set image deployment/cuny-qcc cuny-qcc=$DIGEST
      - kubectl -n $DRONE_COMMIT_BRANCH set image deployment/cuny-qns cuny-qns=$DIGEST
      - kubectl -n $DRONE_COMMIT_BRANCH set image deployment/cuny-yrk cuny-yrk=$DIGEST
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    when:
      branch: staging
      event: [push, tag, deployment]

kubernetes-deploy-production:
    image: library/docker:dind
    commands:
      - docker login --username=$DOCKER_USERNAME --password=$DOCKER_PASSWORD

      # Install Kubectl
      - apk update
      - apk add curl
      - curl -LO https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl
      - chmod +x ./kubectl && mv ./kubectl /usr/local/bin/kubectl

      # Setup Kubectl
      - kubectl config set-credentials default --token=$(echo -n $KUBERNETES_TOKEN | base64 -d)
      - kubectl config set-cluster default --server=$KUBERNETES_MASTER --insecure-skip-tls-verify=true
      - kubectl config set-context default --cluster=default --user=default
      - kubectl config use-context default

      - cd /go/src/github.com/tevjef/uct-core
      - kubectl -n $DRONE_COMMIT_BRANCH apply -R -f kubernetes/production/ein
      - kubectl -n $DRONE_COMMIT_BRANCH apply -R -f kubernetes/production/hermes
      - kubectl -n $DRONE_COMMIT_BRANCH apply -R -f kubernetes/production/julia
      - kubectl -n $DRONE_COMMIT_BRANCH apply -R -f kubernetes/production/postgres
      - kubectl -n $DRONE_COMMIT_BRANCH apply -R -f kubernetes/production/redis

      - kubectl -n $DRONE_COMMIT_BRANCH apply -R -f kubernetes/production/njit-deployment.yml
      - kubectl -n $DRONE_COMMIT_BRANCH apply -R -f kubernetes/production/njit-metrics.yml
      - kubectl -n $DRONE_COMMIT_BRANCH apply -R -f kubernetes/production/rutgers-cm-deployment.yml
      - kubectl -n $DRONE_COMMIT_BRANCH apply -R -f kubernetes/production/rutgers-cm-metrics.yml
      - kubectl -n $DRONE_COMMIT_BRANCH apply -R -f kubernetes/production/rutgers-nb-deployment.yml
      - kubectl -n $DRONE_COMMIT_BRANCH apply -R -f kubernetes/production/rutgers-nb-metrics.yml
      - kubectl -n $DRONE_COMMIT_BRANCH apply -R -f kubernetes/production/rutgers-nk-deployment.yml
      - kubectl -n $DRONE_COMMIT_BRANCH apply -R -f kubernetes/production/rutgers-nk-metrics.yml

      - DIGEST=$(docker inspect --format='{{ index .RepoDigests 0 }}' tevjef/ein:$DRONE_COMMIT_BRANCH)
      - kubectl -n $DRONE_COMMIT_BRANCH set image deployment/ein ein=$DIGEST
  
      - DIGEST=$(docker inspect --format='{{ index .RepoDigests 0 }}' tevjef/spike:$DRONE_COMMIT_BRANCH)
      - kubectl -n $DRONE_COMMIT_BRANCH set image deployment/spike spike=$DIGEST
  
      - DIGEST=$(docker inspect --format='{{ index .RepoDigests 0 }}' tevjef/hermes:$DRONE_COMMIT_BRANCH)
      - kubectl -n $DRONE_COMMIT_BRANCH set image deployment/hermes hermes=$DIGEST
  
      - DIGEST=$(docker inspect --format='{{ index .RepoDigests 0 }}' tevjef/julia:$DRONE_COMMIT_BRANCH)
      - kubectl -n $DRONE_COMMIT_BRANCH set image deployment/julia julia=$DIGEST
  
      - DIGEST=$(docker inspect --format='{{ index .RepoDigests 0 }}' tevjef/rutgers:$DRONE_COMMIT_BRANCH)
      - kubectl -n $DRONE_COMMIT_BRANCH set image deployment/rutgers-cm rutgers-cm=$DIGEST
      - kubectl -n $DRONE_COMMIT_BRANCH set image deployment/rutgers-nb rutgers-nb=$DIGEST
      - kubectl -n $DRONE_COMMIT_BRANCH set image deployment/rutgers-nk rutgers-nk=$DIGEST

      - DIGEST=$(docker inspect --format='{{ index .RepoDigests 0 }}' tevjef/njit:staging)
      - kubectl -n $DRONE_COMMIT_BRANCH set image deployment/njit njit=$DIGEST
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    when:
      branch: production
      event: [push, tag, deployment]